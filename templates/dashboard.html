<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>MT5 Trade Copier Dashboard</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- Modern Bootstrap via CDN -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
      rel="stylesheet"
    >
    <!-- Bootstrap Icons for icon-only buttons -->
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css"
    >
    <style>
      body {
        background: radial-gradient(circle at top left, #0f172a, #020617);
        color: #e5e7eb;
        min-height: 100vh;
      }
      .container {
        max-width: 1400px;
      }
      .nav-tabs .nav-link.active {
        background-color: #0f172a;
        border-color: #38bdf8 #38bdf8 #0f172a;
        color: #e5e7eb;
      }
      .nav-tabs .nav-link {
        color: #9ca3af;
      }
      .card {
        background-color: #020617;
        border-radius: 1rem;
        border: 1px solid #1f2937;
      }
      table.table {
        color: #e5e7eb;
      }
      table thead {
        background: linear-gradient(to right, #0f172a, #1e293b);
      }
      /* Watchlist table: wider, scrollable, and hover highlight */
      .symbol-table-wrapper {
        max-height: 650px; /* ~20 rows visible depending on screen */
        overflow-y: auto;
      }
      /* Dark background for the entire symbol mapping table */
      .symbol-table-wrapper table,
      .symbol-table-wrapper table thead,
      .symbol-table-wrapper table tbody,
      .symbol-table-wrapper table tr,
      .symbol-table-wrapper table th,
      .symbol-table-wrapper table td {
        background-color: #020617 !important;
        border-color: #1f2937;
        color: #f9fafb; /* bright text for readability */
      }
      .symbol-table-wrapper table tbody tr {
        transition: background-color 0.12s ease;
      }
      .symbol-table-wrapper table tbody tr:nth-child(even) {
        background-color: #030712 !important;
      }
      .symbol-table-wrapper table tbody tr:hover {
        background-color: #1f2937 !important;
      }
      .symbol-title,
      .logs-title {
        color: #e5e7eb;
        letter-spacing: 0.02em;
      }
      /* Order logs table: reuse same dark theme */
      .logs-table-wrapper table,
      .logs-table-wrapper table thead,
      .logs-table-wrapper table tbody,
      .logs-table-wrapper table tr,
      .logs-table-wrapper table th,
      .logs-table-wrapper table td {
        background-color: #020617 !important;
        border-color: #1f2937;
        color: #f9fafb;
      }
      .logs-table-wrapper table tbody tr:nth-child(even) {
        background-color: #030712 !important;
      }
      .logs-table-wrapper table tbody tr:hover {
        background-color: #1f2937 !important;
      }
      .filter-label {
        color: #e5e7eb;
        font-weight: 500;
      }
      .date-input {
        background-color: #020617 !important;
        color: #f9fafb !important;
        border-color: #1f2937 !important;
      }
      .btn-apply {
        background: linear-gradient(135deg, #38bdf8, #6366f1);
        border: none;
        color: #f9fafb;
      }
      .btn-apply:disabled {
        opacity: 0.4;
      }
      .btn-gradient {
        background: linear-gradient(135deg, #38bdf8, #6366f1);
        border: none;
        color: white;
      }
      .btn-outline-light {
        border-color: #4b5563;
        color: #e5e7eb;
      }
      .btn-danger-gradient {
        background: linear-gradient(135deg, #f97373, #b91c1c);
        border: none;
        color: #fef2f2;
      }
      .btn-warning-gradient {
        background: linear-gradient(135deg, #fde68a, #f59e0b);
        border: none;
        color: #451a03;
      }
      .badge-latency {
        font-size: 0.75rem;
        padding: 0.25rem 0.5rem;
        border-radius: 999px;
      }
      .badge-fast { background-color: #16a34a; }
      .badge-medium { background-color: #f97316; }
      .badge-slow { background-color: #dc2626; }
    </style>
  </head>
  <body>
    <div class="container py-4">
      <div class="d-flex justify-content-between align-items-center mb-3">
        <div>
          <h2 class="mb-0">MT5 Trade Copier Dashboard</h2>
          <small class="text-secondary">Watchlist &amp; Order Logs with latency</small>
        </div>
        <div class="d-flex align-items-center gap-2">
          <span class="text-secondary small">
            Status:
            {% if copier_running %}
              <span class="text-success">Running</span>
            {% else %}
              <span class="text-danger">Stopped</span>
            {% endif %}
          </span>
          <form action="{{ url_for('copier_start') }}" method="post" class="d-inline">
            <button
              type="submit"
              class="btn btn-gradient btn-sm"
              {% if copier_running %}disabled{% endif %}
              title="Start Copier"
              aria-label="Start Copier"
            >
              <i class="bi bi-play-fill"></i>
            </button>
          </form>
          <form action="{{ url_for('copier_stop') }}" method="post" class="d-inline">
            <button
              type="submit"
              class="btn btn-danger-gradient btn-sm"
              {% if not copier_running %}disabled{% endif %}
              title="Stop Copier"
              aria-label="Stop Copier"
            >
              <i class="bi bi-stop-fill"></i>
            </button>
          </form>
        </div>
      </div>

      {% with messages = get_flashed_messages(with_categories=true) %}
      {% if messages %}
        <div class="mb-3">
          {% for category, message in messages %}
            <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
              {{ message }}
              <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
          {% endfor %}
        </div>
      {% endif %}
      {% endwith %}

      <ul class="nav nav-tabs mb-3">
        <li class="nav-item">
          <a class="nav-link {% if active_tab == 'watchlist' %}active{% endif %}" href="{{ url_for('index', tab='watchlist') }}">Watchlist</a>
        </li>
        <li class="nav-item">
          <a class="nav-link {% if active_tab == 'orderlogs' %}active{% endif %}" href="{{ url_for('index', tab='orderlogs') }}">Order Logs</a>
        </li>
      </ul>

      {% if active_tab == 'watchlist' %}
      <!-- WATCHLIST TAB -->
      <div class="card p-3 mb-4">
        <div class="d-flex flex-wrap justify-content-between align-items-center mb-3 gap-2">
          <h5 class="mb-0 symbol-title">Symbol Mapping</h5>
          <div class="d-flex flex-wrap gap-2">
            <button
              class="btn btn-gradient btn-sm"
              data-bs-toggle="modal"
              data-bs-target="#addSymbolModal"
              title="Add Symbol Mapping"
              aria-label="Add Symbol Mapping"
            >
              <i class="bi bi-plus-circle"></i>
            </button>
            <form action="{{ url_for('watchlist_delete_all') }}" method="post" class="d-inline" onsubmit="return confirm('Delete all symbol mappings?');">
              <button
                type="submit"
                class="btn btn-danger-gradient btn-sm"
                title="Delete All Mappings"
                aria-label="Delete All Mappings"
              >
                <i class="bi bi-trash3"></i>
              </button>
            </form>
            <form action="{{ url_for('watchlist_export') }}" method="get" class="d-inline">
              <button
                type="submit"
                class="btn btn-warning-gradient btn-sm"
                title="Export CSV"
                aria-label="Export CSV"
              >
                <i class="bi bi-download"></i>
              </button>
            </form>
            <form action="{{ url_for('watchlist_import') }}" method="post" enctype="multipart/form-data" class="d-flex align-items-center gap-2">
              <input type="file" name="file" accept=".csv" class="form-control form-control-sm bg-dark text-light" required>
              <button
                type="submit"
                class="btn btn-outline-light btn-sm"
                title="Import CSV (overwrite)"
                aria-label="Import CSV (overwrite)"
              >
                <i class="bi bi-upload"></i>
              </button>
            </form>
            <!-- Search symbol form -->
            <form
              class="d-flex align-items-center gap-1"
              method="get"
              action="{{ url_for('index') }}"
            >
              <input type="hidden" name="tab" value="watchlist">
              <input
                type="text"
                name="search"
                value="{{ search or '' }}"
                class="form-control form-control-sm bg-dark text-light"
                placeholder="Search symbol..."
              >
              <button
                type="submit"
                class="btn btn-apply btn-sm"
                title="Search"
                aria-label="Search"
              >
                <i class="bi bi-search"></i>
              </button>
            </form>
          </div>
        </div>

        <div class="table-responsive symbol-table-wrapper">
          <table class="table table-sm align-middle">
            <thead>
              <tr>
                <th>#</th>
                <th>Master Symbol</th>
                <th>Slave Symbol</th>
                <th>Slave Lot</th>
                <th class="text-end">Actions</th>
              </tr>
            </thead>
            <tbody>
              {% if mapping %}
                {% for row in mapping %}
                <tr>
                  <td>{{ loop.index }}</td>
                  <td>{{ row.master_symbol }}</td>
                  <td>{{ row.slave_symbol }}</td>
                  <td>{{ row.slave_lot }}</td>
                  <td class="text-end">
                    <button
                      class="btn btn-outline-light btn-sm"
                      data-bs-toggle="modal"
                      data-bs-target="#editSymbolModal"
                      data-row-index="{{ loop.index0 }}"
                      data-master="{{ row.master_symbol }}"
                      data-slave="{{ row.slave_symbol }}"
                      data-lot="{{ row.slave_lot }}"
                      title="Edit Mapping"
                      aria-label="Edit Mapping"
                    >
                      <i class="bi bi-pencil-square"></i>
                    </button>
                    <form action="{{ url_for('watchlist_delete', row_index=loop.index0) }}" method="post" class="d-inline" onsubmit="return confirm('Delete this mapping?');">
                      <button
                        type="submit"
                        class="btn btn-outline-danger btn-sm"
                        title="Delete Mapping"
                        aria-label="Delete Mapping"
                      >
                        <i class="bi bi-trash"></i>
                      </button>
                    </form>
                  </td>
                </tr>
                {% endfor %}
              {% else %}
                <tr>
                  <td colspan="5" class="text-center text-secondary py-4">No symbol mappings configured.</td>
                </tr>
              {% endif %}
            </tbody>
          </table>
        </div>
      </div>

      <!-- Add Symbol Modal -->
      <div class="modal fade" id="addSymbolModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
          <div class="modal-content bg-dark text-light">
            <form action="{{ url_for('watchlist_add') }}" method="post">
              <div class="modal-header">
                <h5 class="modal-title">Add Symbol Mapping</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
              </div>
              <div class="modal-body">
                <div class="mb-3">
                  <label class="form-label">Master Symbol</label>
                  <input type="text" name="master_symbol" class="form-control bg-dark text-light" placeholder="e.g. EURUSD.c" required>
                </div>
                <div class="mb-3">
                  <label class="form-label">Slave Symbol</label>
                  <input type="text" name="slave_symbol" class="form-control bg-dark text-light" placeholder="e.g. EURUSD-STD" required>
                </div>
                <div class="mb-3">
                  <label class="form-label">Slave Lot Multiplier</label>
                  <input type="number" step="0.01" name="slave_lot" class="form-control bg-dark text-light" value="1.0" required>
                </div>
              </div>
              <div class="modal-footer">
                <button type="button" class="btn btn-outline-light" data-bs-dismiss="modal">Cancel</button>
                <button type="submit" class="btn btn-gradient">Save</button>
              </div>
            </form>
          </div>
        </div>
      </div>

      <!-- Edit Symbol Modal (re-used for any row) -->
      <div class="modal fade" id="editSymbolModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
          <div class="modal-content bg-dark text-light">
            <form id="editSymbolForm" method="post">
              <div class="modal-header">
                <h5 class="modal-title">Edit Symbol Mapping</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
              </div>
              <div class="modal-body">
                <div class="mb-3">
                  <label class="form-label">Master Symbol</label>
                  <input type="text" name="master_symbol" id="edit-master-symbol" class="form-control bg-dark text-light" required>
                </div>
                <div class="mb-3">
                  <label class="form-label">Slave Symbol</label>
                  <input type="text" name="slave_symbol" id="edit-slave-symbol" class="form-control bg-dark text-light" required>
                </div>
                <div class="mb-3">
                  <label class="form-label">Slave Lot Multiplier</label>
                  <input type="number" step="0.01" name="slave_lot" id="edit-slave-lot" class="form-control bg-dark text-light" required>
                </div>
              </div>
              <div class="modal-footer">
                <button type="button" class="btn btn-outline-light" data-bs-dismiss="modal">Cancel</button>
                <button type="submit" class="btn btn-gradient">Update</button>
              </div>
            </form>
          </div>
        </div>
      </div>

      {% elif active_tab == 'orderlogs' %}
      <!-- ORDER LOGS TAB -->
      <div class="card p-3 mb-4">
        <div class="d-flex flex-wrap justify-content-between align-items-center mb-3 gap-2">
          <h5 class="mb-0 logs-title">Order Logs</h5>
          <div class="d-flex flex-wrap gap-2">
            <form action="{{ url_for('orderlogs_delete_all') }}" method="post" onsubmit="return confirm('Delete all logs?');">
              <button
                type="submit"
                class="btn btn-outline-danger btn-sm"
                title="Delete All Logs"
                aria-label="Delete All Logs"
              >
                <i class="bi bi-trash3"></i>
              </button>
            </form>
          </div>
        </div>

        <form class="row g-2 mb-3" method="get" action="{{ url_for('index') }}">
          <input type="hidden" name="tab" value="orderlogs">
          <div class="col-auto">
            <label class="form-label me-2 filter-label">Filter:</label>
          </div>
          <div class="col-auto">
            <select name="filter" class="form-select form-select-sm bg-dark text-light" onchange="this.form.submit()">
              <option value="today" {% if filter_type == 'today' %}selected{% endif %}>Today</option>
              <option value="all" {% if filter_type == 'all' %}selected{% endif %}>All</option>
              <option value="custom" {% if filter_type == 'custom' %}selected{% endif %}>Custom</option>
            </select>
          </div>
          <div class="col-auto date-field">
            <input type="date" name="start_date" value="{{ start_date }}" class="form-control form-control-sm date-input" {% if filter_type != 'custom' %}disabled{% endif %}>
          </div>
          <div class="col-auto date-field">
            <input type="date" name="end_date" value="{{ end_date }}" class="form-control form-control-sm date-input" {% if filter_type != 'custom' %}disabled{% endif %}>
          </div>
          <div class="col-auto date-field">
            <button
              type="submit"
              class="btn btn-apply btn-sm"
              {% if filter_type != 'custom' %}disabled{% endif %}
              title="Apply Filter"
              aria-label="Apply Filter"
            >
              <i class="bi bi-funnel"></i>
            </button>
          </div>
        </form>

        <form method="post" action="{{ url_for('orderlogs_delete') }}">
          <div class="table-responsive logs-table-wrapper">
            <table class="table table-sm align-middle">
              <thead>
                <tr>
                  <th style="width: 2rem;"><input type="checkbox" id="select-all"></th>
                  <th>Time</th>
                  <th>Latency</th>
                  <th>Raw Log</th>
                </tr>
              </thead>
              <tbody>
                {% if logs %}
                  {% for log in logs %}
                  <tr>
                    <td>
                      <input type="checkbox" name="selected_ids" value="{{ log.id }}" class="log-checkbox">
                    </td>
                    <td>{{ log.timestamp_str }}</td>
                    <td>
                      {% if log.latency_ms is not none %}
                        {% set ms = log.latency_ms %}
                        {% if ms < 300 %}
                          <span class="badge badge-latency badge-fast">{{ '%.1f'|format(ms) }} ms</span>
                        {% elif ms < 800 %}
                          <span class="badge badge-latency badge-medium">{{ '%.1f'|format(ms) }} ms</span>
                        {% else %}
                          <span class="badge badge-latency badge-slow">{{ '%.1f'|format(ms) }} ms</span>
                        {% endif %}
                      {% else %}
                        <span class="text-secondary">N/A</span>
                      {% endif %}
                    </td>
                    <td><code class="text-wrap d-block" style="white-space: pre-wrap;">{{ log.raw }}</code></td>
                  </tr>
                  {% endfor %}
                {% else %}
                  <tr>
                    <td colspan="4" class="text-center text-secondary py-4">No logs available for the selected filter.</td>
                  </tr>
                {% endif %}
              </tbody>
            </table>
          </div>

          <div class="mt-2 d-flex justify-content-between align-items-center">
            <small class="text-secondary">{{ logs|length }} log(s) shown.</small>
            <button
              type="submit"
              class="btn btn-outline-danger btn-sm"
              onclick="return confirm('Delete selected logs?');"
              title="Delete Selected Logs"
              aria-label="Delete Selected Logs"
            >
              <i class="bi bi-trash"></i>
            </button>
          </div>
        </form>
      </div>
      {% endif %}
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script>
      // Enable select-all for logs
      const selectAll = document.getElementById('select-all');
      if (selectAll) {
        selectAll.addEventListener('change', function() {
          document.querySelectorAll('.log-checkbox').forEach(cb => {
            cb.checked = selectAll.checked;
          });
        });
      }

      // Populate edit modal with row data
      const editModal = document.getElementById('editSymbolModal');
      if (editModal) {
        editModal.addEventListener('show.bs.modal', event => {
          const button = event.relatedTarget;
          const index = button.getAttribute('data-row-index');
          const master = button.getAttribute('data-master');
          const slave = button.getAttribute('data-slave');
          const lot = button.getAttribute('data-lot');

          document.getElementById('edit-master-symbol').value = master;
          document.getElementById('edit-slave-symbol').value = slave;
          document.getElementById('edit-slave-lot').value = lot;
          const form = document.getElementById('editSymbolForm');
          form.action = "{{ url_for('watchlist_edit', row_index=0) }}".replace('0', index);
        });
      }

      // Enable/disable custom date fields based on filter selection (client-side)
      const filterSelect = document.querySelector('select[name=\"filter\"]');
      const startInput = document.querySelector('input[name=\"start_date\"]');
      const endInput = document.querySelector('input[name=\"end_date\"]');
      const dateFields = document.querySelectorAll('.date-field');
      if (filterSelect && startInput && endInput) {
        const toggleDates = () => {
          const isCustom = filterSelect.value === 'custom';
          startInput.disabled = !isCustom;
          endInput.disabled = !isCustom;
          dateFields.forEach(df => {
            df.style.display = isCustom ? '' : 'none';
          });
        };
        filterSelect.addEventListener('change', toggleDates);
        toggleDates();
      }
    </script>
  </body>
  </html>

